#
# flake.nix for XDP2 - Development Shell Only
#
# This flake.nix provides a fast development environment for the XDP2 project
#
# To enter the development environment:
# nix develop

# If flakes are not enabled, use the following command to enter the development environment:
# nix --extra-experimental-features 'nix-command flakes' develop .
#
# To enable flakes, you may need to enable them in your system configuration:
# test -d /etc/nix || sudo mkdir /etc/nix
# echo 'experimental-features = nix-command flakes' | sudo tee -a /etc/nix/nix.conf
#
# Debugging:
# XDP2_NIX_DEBUG=7 nix develop --verbose --print-build-logs
#
# Not really sure what the difference between the two is, but the second one is faster
# nix --extra-experimental-features 'nix-command flakes' --option eval-cache false develop
# nix --extra-experimental-features 'nix-command flakes' develop --no-write-lock-file
#
# nix --extra-experimental-features 'nix-command flakes' print-dev-env --json
#
{
  description = "XDP2 development environment";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.${system};
        lib = nixpkgs.lib;
        llvmP = pkgs.llvmPackages_20;

        # Create a Python environment with scapy
        pythonWithScapy = pkgs.python3.withPackages (ps: [ ps.scapy ]);

        sharedConfig = {

          # Debug configuration
          nixDebug = let
            envDebug = builtins.getEnv "XDP2_NIX_DEBUG";
          in
            if envDebug == "" then 0 else builtins.fromJSON envDebug;

          # GCC-only configuration.  These variables could be used to select clang
          useGCC = true;
          selectedCCPkgs = pkgs.gcc;
          selectedCXXPkgs = pkgs.gcc;
          selectedCCBin = "gcc";
          selectedCXXBin = "g++";
          compilerInfo = "GCC";

          configAgeWarningDays = 14;  # Configurable threshold for stale config warnings

          # Function registry for shellcheck validation
          functionRegistry = [
            { name = "navigate-to-repo-root"; description = "Navigate to repository root"; category = "navigation"; }
            { name = "navigate-to-component"; description = "Navigate to component directory"; category = "navigation"; }
            { name = "add-to-path"; description = "Add path to PATH if not present"; category = "utility"; }
            { name = "clean-cppfront"; description = "Clean cppfront build artifacts"; category = "clean"; }
            { name = "clean-xdp2-compiler"; description = "Clean xdp2-compiler build artifacts"; category = "clean"; }
            { name = "clean-xdp2"; description = "Clean xdp2 build artifacts"; category = "clean"; }
            { name = "build-cppfront"; description = "Build cppfront compiler"; category = "build"; }
            { name = "build-xdp2-compiler"; description = "Build xdp2 compiler"; category = "build"; }
            { name = "build-xdp2"; description = "Build main XDP2 project"; category = "build"; }
            { name = "check-cppfront-age"; description = "Check cppfront age and rebuild if needed"; category = "utility"; }
            { name = "build-all"; description = "Build all components"; category = "composite"; }
            { name = "clean-all"; description = "Clean all build artifacts"; category = "composite"; }
            { name = "check-platform-compatibility"; description = "Check platform compatibility"; category = "validation"; }
            { name = "detect-repository-root"; description = "Detect repository root"; category = "validation"; }
            { name = "setup-locale-support"; description = "Setup locale support"; category = "validation"; }
            { name = "run-shellcheck"; description = "Validate all shell functions"; category = "validation"; }
            { name = "xdp2-help"; description = "Show help information"; category = "help"; }
          ];

          # https://nixos.wiki/wiki/C#Hardening_flags
          # hardeningDisable = [ "fortify" "fortify3" "stackprotector" "strictoverflow" ];
          # Disable all hardening flags for now, but might restore some later
          hardeningDisable = [ "all" ];

          # Library packages
          corePackages = with pkgs; [
            # Build tools
            gnumake pkg-config bison flex
            # Core utilities
            bash coreutils gnused gawk gnutar xz git
            # Libraries
            boost
            libpcap
            libelf
            libbpf
            pythonWithScapy
            # Development tools
            graphviz
            bpftools
            # Compilers
            gcc
            llvmP.clang llvmP.llvm.dev llvmP.clang-unwrapped
            # Debugging tools
            glibc_multi.bin
            gdb
            valgrind
            strace
            ltrace
            # Code quality
            shellcheck
            # ASCII art generator for logo display
            jp2a
            # Locale support for cross-distribution compatibility
            glibcLocales
          ];

          buildInputs = with pkgs; [
            boost
            libpcap
            libelf
            libbpf
            pythonWithScapy
            llvmP.llvm llvmP.clang-unwrapped
            llvmP.libclang
            llvmP.lld
          ];

          nativeBuildInputs = [
            pkgs.pkg-config
            llvmP.clang
            llvmP.llvm.dev
          ];
        };

        # Create a wrapper for llvm-config to include clang paths (for libclang)
        llvm-config-wrapped = pkgs.runCommand "llvm-config-wrapped" { } ''
          mkdir -p $out/bin
          cat > $out/bin/llvm-config <<EOF
          #!${pkgs.bash}/bin/bash
          if [[ "\$1" == "--includedir" ]]; then
            echo "${llvmP.clang-unwrapped.dev}/include"
          elif [[ "\$1" == "--libdir" ]]; then
            echo "${lib.getLib llvmP.clang-unwrapped}/lib"
          else
            ${llvmP.llvm.dev}/bin/llvm-config "\$@"
          fi
          EOF
          chmod +x $out/bin/llvm-config
        '';

        # Environment variables for development shell
        sharedEnvVars = ''
          # Compiler settings (GCC-only)
          export CC=${sharedConfig.selectedCCPkgs}/bin/${sharedConfig.selectedCCBin}
          export CXX=${sharedConfig.selectedCXXPkgs}/bin/${sharedConfig.selectedCXXBin}
          export HOST_CC=${sharedConfig.selectedCCPkgs}/bin/${sharedConfig.selectedCCBin}
          export HOST_CXX=${sharedConfig.selectedCXXPkgs}/bin/${sharedConfig.selectedCXXBin}

          # Clang environment variables for xdp2-compiler
          export XDP2_CLANG_VERSION="$(${llvmP.llvm.dev}/bin/llvm-config --version)"
          export XDP2_C_INCLUDE_PATH="${llvmP.clang-unwrapped.dev}/include/clang"
          export XDP2_CLANG_RESOURCE_PATH="${llvmP.clang-unwrapped.dev}/include/clang"

          # Python environment
          export CFLAGS_PYTHON="$(pkg-config --cflags python3-embed)"
          export LDFLAGS_PYTHON="$(pkg-config --libs python3-embed)"
          export PYTHON_VER=3
          export PYTHONPATH="${pkgs.python3}/lib/python3.13/site-packages:$PYTHONPATH"

          # LLVM/Clang settings
          export HOST_LLVM_CONFIG="${llvm-config-wrapped}/bin/llvm-config"
          export LLVM_LIBS="-L${llvmP.llvm}/lib"
          export CLANG_LIBS="-lclang -lLLVM -lclang-cpp"

          # libclang configuration
          export LIBCLANG_PATH=${llvmP.libclang.lib}/lib
          export LD_LIBRARY_PATH=${llvmP.libclang.lib}/lib:$LD_LIBRARY_PATH

          # Boost libraries
          export BOOST_LIBS="-lboost_wave -lboost_thread -lboost_filesystem -lboost_system -lboost_program_options"

          # Other libraries
          export LIBS="-lpthread -ldl -lutil"
          export PATH_ARG=""

          # Build configuration
          export PKG_CONFIG_PATH=${pkgs.lib.makeSearchPath "lib/pkgconfig" sharedConfig.corePackages}
          export XDP2_COMPILER_DEBUG=1

          # Configuration management
          export CONFIG_AGE_WARNING_DAYS=${toString sharedConfig.configAgeWarningDays}
        '';

        # Smart configure script execution with age checking
        # This simply includes a check to see if the config.mk file exists, and
        # it generates a warning if the file is older than the threshold
        smart-configure = ''
          smart-configure() {
            local config_file="./src/config.mk"
            local warning_days=${toString sharedConfig.configAgeWarningDays}

            if [ -f "$config_file" ]; then
              echo "✓ config.mk found, skipping configure step"

              # Check age of config.mk
              local file_time
              file_time=$(stat -c %Y "$config_file")
              local current_time
              current_time=$(date +%s)
              local age_days=$(( (current_time - file_time) / 86400 ))

              if [ "$age_days" -gt "$warning_days" ]; then
                echo "⚠️  WARNING: config.mk is $age_days days old (threshold: $warning_days days)"
                echo "   Consider running 'configure' manually if you've made changes to:"
                echo "   • Build configuration"
                echo "   • Compiler settings"
                echo "   • Library paths"
                echo "   • Platform-specific settings"
                echo ""
              else
                echo "✓ config.mk is up to date ($age_days days old)"
              fi
            else
              echo "config.mk not found, running configure script..."
              cd src || return 1
            rm -f config.mk
              ./configure --build-opt-parser --installdir "/tmp/xdp2-install"

              # Apply PATH_ARG fix for Nix environment
            if grep -q 'PATH_ARG="--with-path=' config.mk; then
                echo "Applying PATH_ARG fix for Nix environment..."
              sed -i 's|PATH_ARG="--with-path=.*"|PATH_ARG=""|' config.mk
            fi
            echo "PATH_ARG in config.mk: $(grep '^PATH_ARG=' config.mk)"

              cd .. || return 1
              echo "✓ config.mk generated successfully"
            fi
          }
        '';

        # Individual build function definitions
        build-cppfront-fn = ''
          build-cppfront() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi
            local start_time=""
            local end_time=""

            if [ "$debug_level" -gt 3 ]; then
              start_time=$(date +%s)
              echo "[DEBUG] build-cppfront started at $(date)"
            fi

            # Level 1: Function start
            if [ "$debug_level" -ge 1 ]; then
              echo "[DEBUG] Starting build-cppfront function"
            fi

            # Clean
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Cleaning cppfront build directory"
            fi
            echo "Cleaning and building cppfront-compiler..."

            # Navigate to repository root first
            navigate-to-repo-root || return 1

            # Clean previous build artifacts (before navigating to component)
            clean-cppfront

            # Navigate to cppfront directory
            navigate-to-component "thirdparty/cppfront" || return 1

            # Apply essential header fix for cppfront
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Applying cppfront header fix"
              printf "sed -i '1i#include <functional>\\n#include <unordered_map>\\n' include/cpp2util.h\n"
            fi
            sed -i '1i#include <functional>\n#include <unordered_map>\n' include/cpp2util.h

            # Level 3: Build step details
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Building cppfront-compiler with make"
            fi

            # Build cppfront with error checking
            if HOST_CXX="$CXX" HOST_CC="$CC" make; then
              echo "✓ cppfront make completed successfully"
            else
              echo "✗ ERROR: cppfront make failed"
              return 1
            fi

            # Return to repository root
            navigate-to-repo-root || return 1

            # Add to the PATH
            add-to-path "$PWD/thirdparty/cppfront"

            # Level 2: Validation step
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Validating cppfront-compiler binary"
            fi

            # Validate binary was created
            if [ -x "./thirdparty/cppfront/cppfront-compiler" ]; then
              echo "✓ cppfront-compiler binary created and executable"

              # Test the binary runs correctly
              echo "Testing cppfront-compiler..."
              set +e  # Temporarily disable exit on error

              # Debug output for validation command
              if [ "$debug_level" -gt 3 ]; then
                echo "[DEBUG] About to run: ./thirdparty/cppfront/cppfront-compiler -version"
              fi
              ./thirdparty/cppfront/cppfront-compiler -version
              test_exit_code=$?
              set -e  # Re-enable exit on error

              if [ "$test_exit_code" -eq 0 ] || [ "$test_exit_code" -eq 1 ]; then
                echo "✓ cppfront-compiler runs correctly (exit code: $test_exit_code)"
              else
                echo "⚠ WARNING: cppfront-compiler returned unexpected exit code: $test_exit_code"
                echo "But binary exists and is executable, continuing..."
              fi
            else
              echo "✗ ERROR: cppfront-compiler binary not found or not executable"
              return 1
            fi

            # End timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              end_time=$(date +%s)
              local duration=$((end_time - start_time))
              echo "[DEBUG] build-cppfront completed in $duration seconds"
            fi

            echo "cppfront-compiler built and validated successfully"
          }
        '';

        check-cppfront-age-fn = ''
          check-cppfront-age() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi
            local start_time=""
            local end_time=""

            # Start timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              start_time=$(date +%s)
              echo "[DEBUG] check-cppfront-age started at $(date)"
            fi

            # Level 1: Function start
            if [ "$debug_level" -ge 1 ]; then
              echo "[DEBUG] Starting check-cppfront-age function"
            fi

            local cppfront_binary="thirdparty/cppfront/cppfront-compiler"

            # Level 2: File check
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Checking cppfront binary: $cppfront_binary"
            fi

            if [ -f "$cppfront_binary" ]; then
              local file_time
              file_time=$(stat -c %Y "$cppfront_binary")
              local current_time
              current_time=$(date +%s)
              local age_days=$(( (current_time - file_time) / 86400 ))

              # Level 3: Age calculation details
              if [ "$debug_level" -ge 3 ]; then
                echo "[DEBUG] File modification time: $file_time"
                echo "[DEBUG] Current time: $current_time"
                echo "[DEBUG] Calculated age: $age_days days"
              fi

              if [ "$age_days" -gt 7 ]; then
                echo "cppfront is $age_days days old, rebuilding..."
                build-cppfront
              else
                echo "cppfront is up to date ($age_days days old)"
              fi
            else
              echo "cppfront not found, building..."
              build-cppfront
            fi

            # End timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              end_time=$(date +%s)
              local duration=$((end_time - start_time))
              echo "[DEBUG] check-cppfront-age completed in $duration seconds"
            fi
          }
        '';

        build-xdp2-compiler-fn = ''
          build-xdp2-compiler() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi
            local start_time=""
            local end_time=""

            # Start timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              start_time=$(date +%s)
              echo "[DEBUG] build-xdp2-compiler started at $(date)"
            fi

            # Level 1: Function start
            if [ "$debug_level" -ge 1 ]; then
              echo "[DEBUG] Starting build-xdp2-compiler function"
            fi

            # Level 2: Clean step
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Cleaning xdp2-compiler build directory"
            fi
            echo "Cleaning and building xdp2-compiler..."

            # Navigate to repository root first
            navigate-to-repo-root || return 1

            # Clean previous build artifacts (before navigating to component)
            clean-xdp2-compiler

            # Navigate to xdp2-compiler directory
            navigate-to-component "src/tools/compiler" || return 1

            # Level 3: Build step details
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Building xdp2-compiler with make"
            fi

            # Build xdp2-compiler with error checking
            if CFLAGS_PYTHON="$CFLAGS_PYTHON" LDFLAGS_PYTHON="$LDFLAGS_PYTHON" make; then
              echo "✓ xdp2-compiler make completed successfully"
            else
              echo "✗ ERROR: xdp2-compiler make failed"
              return 1
            fi

            # Level 2: Validation step
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Validating xdp2-compiler binary"
            fi

            # Validate binary was created
            if [ -x "./xdp2-compiler" ]; then
              echo "✓ xdp2-compiler binary created and executable"

              # Test the binary runs correctly
              echo "Testing xdp2-compiler..."
              set +e  # Temporarily disable exit on error

              # Debug output for validation command
              if [ "$debug_level" -gt 3 ]; then
                echo "[DEBUG] About to run: ./xdp2-compiler --help"
              fi
              ./xdp2-compiler --help
              test_exit_code=$?
              set -e  # Re-enable exit on error

              if [ "$test_exit_code" -eq 0 ] || [ "$test_exit_code" -eq 1 ]; then
                echo "✓ xdp2-compiler runs correctly (exit code: $test_exit_code)"
              else
                echo "⚠ WARNING: xdp2-compiler returned unexpected exit code: $test_exit_code"
                echo "But binary exists and is executable, continuing..."
              fi
            else
              echo "✗ ERROR: xdp2-compiler binary not found or not executable"
              return 1
            fi

            # Return to repository root
            navigate-to-repo-root || return 1

            # End timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              end_time=$(date +%s)
              local duration=$((end_time - start_time))
              echo "[DEBUG] build-xdp2-compiler completed in $duration seconds"
            fi

            echo "xdp2-compiler built and validated successfully"
          }
        '';

        build-xdp2-fn = ''
          build-xdp2() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi
            local start_time=""
            local end_time=""

            # Start timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              start_time=$(date +%s)
              echo "[DEBUG] build-xdp2 started at $(date)"
            fi

            # Level 1: Function start
            if [ "$debug_level" -ge 1 ]; then
              echo "[DEBUG] Starting build-xdp2 function"
            fi

            # Level 2: Clean step
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Cleaning xdp2 project build directory"
            fi
            echo "Cleaning and building xdp2 project..."

            # Navigate to repository root first
            navigate-to-repo-root || return 1

            # Clean previous build artifacts (before navigating to component)
            clean-xdp2

            # Navigate to src directory
            navigate-to-component "src" || return 1

            # Ensure xdp2-compiler is available in PATH
            add-to-path "$PWD/tools/compiler"
            echo "Added tools/compiler to PATH"

            # Level 3: Build step details
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Building xdp2 project with make"
            fi

            # Build the main xdp2 project
            if make; then
              echo "✓ xdp2 project make completed successfully"
            else
              echo "✗ ERROR: xdp2 project make failed"
              echo "   Check the error messages above for details"
              return 1
            fi

            # Return to repository root
            navigate-to-repo-root || return 1

            # End timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              end_time=$(date +%s)
              local duration=$((end_time - start_time))
              echo "[DEBUG] build-xdp2 completed in $duration seconds"
            fi

            echo "xdp2 project built successfully"
          }
        '';

        build-all-fn = ''
          build-all() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi

            echo "Building all XDP2 components..."

            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Building cppfront: build-cppfront"
            fi
            build-cppfront

            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Building xdp2-compiler: build-xdp2-compiler"
            fi
            build-xdp2-compiler

            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Building xdp2: build-xdp2"
            fi
            build-xdp2

            echo "✓ All components built successfully"
          }
        '';

        clean-all-fn = ''
          clean-all() {
            echo "Cleaning all build artifacts..."

            # Clean each component using centralized clean functions
            clean-cppfront
            clean-xdp2-compiler
            clean-xdp2

            echo "✓ All build artifacts cleaned"
          }
        '';

        # Generate shellcheck validation function using function registry
        generate-shellcheck-validation = let
          functionNames = map (f: f.name) sharedConfig.functionRegistry;
          functionList = lib.concatStringsSep "\n      " (map (name: "\"${name}\"") functionNames);
        in ''
          run-shellcheck() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi
            local start_time=""
            local end_time=""

            # Start timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              start_time=$(date +%s)
              echo "[DEBUG] run-shellcheck started at $(date)"
            fi

            # Level 1: Function start
            if [ "$debug_level" -ge 1 ]; then
              echo "[DEBUG] Starting run-shellcheck function"
            fi

            # Level 2: Check shellcheck availability
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Checking shellcheck availability"
            fi

            if ! command -v shellcheck >/dev/null 2>&1; then
              echo "✗ ERROR: shellcheck not found in PATH"
              echo "Please install shellcheck to validate bash code"
              return 1
            fi

            echo "✓ shellcheck found: $(which shellcheck)"

            # Level 3: Define function list from registry
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Using function registry for validation"
            fi

            echo "Running shellcheck validation on shell functions..."

            # Function registry from Nix
            local functions=(
              ${functionList}
            )
            
            local failed_functions=()
            local total_functions=0
            local passed_functions=0
            
            # Validate all functions as a complete script to provide proper context
            echo "Validating all shell functions with proper context..."

            # Create a temporary script with all function definitions
            local temp_script="/tmp/xdp2_functions_validation.sh"

            # Write all function definitions to temporary script
            cat > "$temp_script" << 'EOF'
#!/bin/bash
# Temporary script for shellcheck validation of all XDP2 functions

# Navigation functions (called by all other functions)
navigate-to-repo-root() {
  local repo_root="$XDP2_REPO_ROOT"
  if [ -n "$repo_root" ]; then
    if ! cd "$repo_root"; then
      echo "✗ ERROR: Cannot navigate to repository root: $repo_root"
      return 1
    fi
  else
    echo "✗ ERROR: XDP2_REPO_ROOT not set"
    return 1
  fi
}

navigate-to-component() {
  local component="$1"
  if [ -z "$component" ]; then
    echo "✗ ERROR: Component name required"
    return 1
  fi
  
  navigate-to-repo-root || return 1
  
  if ! cd "$component"; then
    echo "✗ ERROR: Cannot navigate to component: $component"
    return 1
  fi
}

# Utility functions
add-to-path() {
  local path_to_add="$1"
  
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  # Check if path is already in PATH
  if [[ ":$PATH:" == *":$path_to_add:"* ]]; then
    if [ "$debug_level" -gt 3 ]; then
      echo "[DEBUG] Path already in PATH: $path_to_add"
    fi
    return 0
  fi

  # Add path to beginning of PATH
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] Adding to PATH: $path_to_add"
    echo "[DEBUG] PATH before: $PATH"
  fi
  
  export PATH="$path_to_add:$PATH"
  
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] PATH after: $PATH"
  fi
}

# Individual clean functions
clean-cppfront() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  # Navigate to repository root first
  navigate-to-repo-root || return 1

  # Navigate to cppfront directory
  navigate-to-component "thirdparty/cppfront" || return 1

  # Debug output for clean command
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: rm -f cppfront-compiler"
  fi
  rm -f cppfront-compiler

  # Return to repository root
  navigate-to-repo-root || return 1
}

clean-xdp2-compiler() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  # Navigate to repository root first
  navigate-to-repo-root || return 1

  # Navigate to tools/compiler directory
  navigate-to-component "tools/compiler" || return 1

  # Debug output for clean command
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi
  make clean || true  # Don't fail if clean fails

  # Return to repository root
  navigate-to-repo-root || return 1
}

clean-xdp2() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  # Navigate to repository root first
  navigate-to-repo-root || return 1

  # Navigate to src directory
  navigate-to-component "src" || return 1

  # Debug output for clean command
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi
  make clean || true  # Don't fail if clean fails

  # Return to repository root
  navigate-to-repo-root || return 1
}

# Individual build functions
build-cppfront() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi
  local start_time
  local end_time

  # Start timing for debug levels > 3
  if [ "$debug_level" -gt 3 ]; then
    start_time=$(date +%s)
    echo "[DEBUG] build-cppfront started at $(date)"
  fi

  # Level 1: Function start
  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] Starting build-cppfront function"
  fi

  # Level 2: Clean before build
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Cleaning cppfront build directory"
  fi

  echo "Cleaning and building cppfront-compiler..."

  # Clean before building
  clean-cppfront

  # Navigate to repository root first
  navigate-to-repo-root || return 1

  # Navigate to cppfront directory
  navigate-to-component "thirdparty/cppfront" || return 1

  # Debug output for clean command
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi
  make clean || true  # Don't fail if clean fails

  # Apply cppfront header fix
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Applying cppfront header fix"
  fi
  printf "sed -i '1i#include <functional>\n#include <unordered_map>\n' include/cpp2util.h\n"

  # Build cppfront-compiler
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Building cppfront-compiler with make"
  fi
  if ! make; then
    echo "✗ cppfront make failed"
    return 1
  fi

  echo "✓ cppfront make completed successfully"

  # Return to repository root
  navigate-to-repo-root || return 1

  # Validate cppfront-compiler binary
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Validating cppfront-compiler binary"
  fi

  if [ ! -f "thirdparty/cppfront/cppfront-compiler" ]; then
    echo "✗ ERROR: cppfront-compiler binary not created"
    return 1
  fi

  if [ ! -x "thirdparty/cppfront/cppfront-compiler" ]; then
    echo "✗ ERROR: cppfront-compiler binary not executable"
    return 1
  fi

  echo "✓ cppfront-compiler binary created and executable"

  # Test cppfront-compiler
  echo "Testing cppfront-compiler..."
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: ./thirdparty/cppfront/cppfront-compiler -version"
  fi
  if ! ./thirdparty/cppfront/cppfront-compiler -version; then
    echo "✗ ERROR: cppfront-compiler test failed"
    return 1
  fi

  echo "✓ cppfront-compiler runs correctly (exit code: $?)"

  # End timing for debug levels > 3
  if [ "$debug_level" -gt 3 ]; then
    end_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-cppfront completed in $duration seconds"
  fi

  echo "cppfront-compiler built and validated successfully"
}

build-xdp2-compiler() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi
  local start_time
  local end_time

  # Start timing for debug levels > 3
  if [ "$debug_level" -gt 3 ]; then
    start_time=$(date +%s)
    echo "[DEBUG] build-xdp2-compiler started at $(date)"
  fi

  # Level 1: Function start
  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] Starting build-xdp2-compiler function"
  fi

  # Level 2: Clean before build
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Cleaning xdp2-compiler build directory"
  fi

  echo "Cleaning and building xdp2-compiler..."

  # Clean before building
  clean-xdp2-compiler

  # Navigate to repository root first
  navigate-to-repo-root || return 1

  # Navigate to tools/compiler directory
  navigate-to-component "tools/compiler" || return 1

  # Debug output for clean command
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi
  make clean || true  # Don't fail if clean fails

  # Build xdp2-compiler
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Building xdp2-compiler with make"
  fi
  if ! make; then
    echo "✗ xdp2-compiler make failed"
    return 1
  fi

  echo "✓ xdp2-compiler make completed successfully"

  # Return to repository root
  navigate-to-repo-root || return 1

  # Validate xdp2-compiler binary
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Validating xdp2-compiler binary"
  fi

  if [ ! -f "tools/compiler/xdp2-compiler" ]; then
    echo "✗ ERROR: xdp2-compiler binary not created"
    return 1
  fi

  if [ ! -x "tools/compiler/xdp2-compiler" ]; then
    echo "✗ ERROR: xdp2-compiler binary not executable"
    return 1
  fi

  echo "✓ xdp2-compiler binary created and executable"

  # Test xdp2-compiler
  echo "Testing xdp2-compiler..."
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: ./tools/compiler/xdp2-compiler --help"
  fi
  if ! ./tools/compiler/xdp2-compiler --help; then
    echo "✗ ERROR: xdp2-compiler test failed"
    return 1
  fi

  echo "✓ xdp2-compiler runs correctly (exit code: $?)"

  # End timing for debug levels > 3
  if [ "$debug_level" -gt 3 ]; then
    end_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-xdp2-compiler completed in $duration seconds"
  fi

  echo "xdp2-compiler built and validated successfully"
}

build-xdp2() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi
  local start_time
  local end_time

  # Start timing for debug levels > 3
  if [ "$debug_level" -gt 3 ]; then
    start_time=$(date +%s)
    echo "[DEBUG] build-xdp2 started at $(date)"
  fi

  # Level 1: Function start
  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] Starting build-xdp2 function"
  fi

  # Level 2: Clean before build
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Cleaning xdp2 build directory"
  fi

  echo "Cleaning and building xdp2 project..."

  # Clean before building
  clean-xdp2

  # Navigate to repository root first
  navigate-to-repo-root || return 1

  # Navigate to src directory
  navigate-to-component "src" || return 1

  # Debug output for clean command
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi
  make clean || true  # Don't fail if clean fails

  # Build xdp2 project
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Building xdp2 project with make"
  fi
  if ! make; then
    echo "✗ xdp2 make failed"
    return 1
  fi

  echo "✓ xdp2 make completed successfully"

  # Return to repository root
  navigate-to-repo-root || return 1

  # Validate xdp2 binaries
  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Validating xdp2 binaries"
  fi

  # Check for main xdp2 binary
  if [ ! -f "src/xdp2" ]; then
    echo "✗ ERROR: xdp2 binary not created"
    return 1
  fi

  if [ ! -x "src/xdp2" ]; then
    echo "✗ ERROR: xdp2 binary not executable"
    return 1
  fi

  echo "✓ xdp2 binary created and executable"

  # Check for libxdp2.a library
  if [ ! -f "src/libxdp2.a" ]; then
    echo "✗ ERROR: libxdp2.a library not created"
    return 1
  fi

  echo "✓ libxdp2.a library created"

  # Test xdp2 binary
  echo "Testing xdp2 binary..."
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] About to run: ./src/xdp2 --help"
  fi
  if ! ./src/xdp2 --help; then
    echo "✗ ERROR: xdp2 test failed"
    return 1
  fi

  echo "✓ xdp2 runs correctly (exit code: $?)"

  # End timing for debug levels > 3
  if [ "$debug_level" -gt 3 ]; then
    end_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-xdp2 completed in $duration seconds"
  fi

  echo "xdp2 project built successfully"
}

# Composite functions (call the individual functions above)
build-all() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] build-all started at $(date)"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Starting build-all function"
  fi

  echo "Building all XDP2 components..."

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building cppfront compiler"
  fi

  if ! build-cppfront; then
    echo "✗ build-cppfront failed"
    return 1
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building xdp2-compiler"
  fi

  if ! build-xdp2-compiler; then
    echo "✗ build-xdp2-compiler failed"
    return 1
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building xdp2 project"
  fi

  if ! build-xdp2; then
    echo "✗ build-xdp2 failed"
    return 1
  fi

  if [ "$debug_level" -ge 1 ]; then
    local end_time
    end_time=$(date +%s)
    local start_time
    start_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-all completed in $duration seconds"
  fi

  echo "All XDP2 components built successfully!"
}

clean-all() {
  echo "Cleaning all build artifacts..."

  clean-cppfront
  clean-xdp2-compiler
  clean-xdp2

  echo "✓ All build artifacts cleaned"
}

# Validation and help functions
run-shellcheck() {
  echo "This is a placeholder for the run-shellcheck function"
}

xdp2-help() {
  echo "This is a placeholder for the xdp2-help function"
}
EOF

            # Use shellcheck on the temporary script
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Running shellcheck on temporary script: $temp_script"
            fi

            if shellcheck -s bash "$temp_script"; then
              echo "✓ All functions passed shellcheck validation"
              rm -f "$temp_script"
              return 0
            else
              echo "✗ Some functions failed shellcheck validation"
              echo "Temporary script saved at: $temp_script"
              echo "Run 'shellcheck -s bash $temp_script' to see detailed errors"
              return 1
            fi

            # End timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              end_time=$(date +%s)
              local duration=$((end_time - start_time))
              echo "[DEBUG] run-shellcheck completed in $duration seconds"
            fi

            echo "✓ Shellcheck validation completed"
            return 0
          }
        '';

        run-shellcheck-fn = generate-shellcheck-validation;
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi
            local start_time=""
            local end_time=""

            # Start timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              start_time=$(date +%s)
              echo "[DEBUG] run-shellcheck started at $(date)"
            fi

            # Level 1: Function start
            if [ "$debug_level" -ge 1 ]; then
              echo "[DEBUG] Starting run-shellcheck function"
            fi

            # Level 2: Check shellcheck availability
            if [ "$debug_level" -ge 2 ]; then
              echo "[DEBUG] Checking shellcheck availability"
            fi

            if ! command -v shellcheck >/dev/null 2>&1; then
              echo "✗ ERROR: shellcheck not found in PATH"
              echo "Please install shellcheck to validate bash code"
              return 1
            fi

            echo "✓ shellcheck found: $(which shellcheck)"

            # Level 3: Define function list
            if [ "$debug_level" -ge 3 ]; then
              echo "[DEBUG] Defining list of functions to check"
            fi

            echo "Running shellcheck validation on shell functions..."

            # Validate all functions as a complete script to provide proper context
            echo "Validating all shell functions with proper context..."

            # Create a temporary script with all function definitions
            local temp_script="/tmp/xdp2_functions_validation.sh"

            # Write all function definitions to temporary script
            cat > "$temp_script" << 'EOF'
#!/bin/bash
# Temporary script for shellcheck validation of all XDP2 functions

# Navigation functions (called by all other functions)
navigate-to-repo-root() {
  local repo_root="$XDP2_REPO_ROOT"

  if [ ! -d "$repo_root" ]; then
    echo "✗ ERROR: Repository root not found: $repo_root"
    return 1
  fi

  cd "$repo_root" || return 1
}

navigate-to-component() {
  local component="$1"
  local target_dir="$XDP2_REPO_ROOT/$component"

  if [ ! -d "$target_dir" ]; then
    echo "✗ ERROR: Component directory not found: $target_dir"
    return 1
  fi

  cd "$target_dir" || return 1
}

# Utility functions
add-to-path() {
  local path_to_add="$1"

  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  # Check if path is already in PATH
  if [[ ":$PATH:" == *":$path_to_add:"* ]]; then
    if [ "$debug_level" -gt 3 ]; then
      echo "[DEBUG] Path already in PATH: $path_to_add"
    fi
    return 0
  fi

  # Add path to beginning of PATH
  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] Adding to PATH: $path_to_add"
    echo "[DEBUG] PATH before: $PATH"
  fi

  export PATH="$path_to_add:$PATH"

  if [ "$debug_level" -gt 3 ]; then
    echo "[DEBUG] PATH after: $PATH"
  fi
}

# Individual clean functions (called by build functions and clean-all)
clean-cppfront() {
  navigate-to-repo-root || return 1
  cd thirdparty/cppfront || return 1
  rm -f cppfront-compiler
  navigate-to-repo-root || return 1
}

clean-xdp2-compiler() {
  navigate-to-repo-root || return 1
  cd src/tools/compiler || return 1
  make clean || true
  navigate-to-repo-root || return 1
}

clean-xdp2() {
  navigate-to-repo-root || return 1
  cd src || return 1
  make clean || true
  navigate-to-repo-root || return 1
}

# Individual build functions (called by build-all)
build-cppfront() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] build-cppfront started at $(date)"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Starting build-cppfront function"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Cleaning cppfront build directory"
  fi

  clean-cppfront

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: cd thirdparty/cppfront"
  fi

  navigate-to-component "thirdparty/cppfront" || return 1

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi

  rm -f cppfront-compiler

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Applying cppfront header fix"
    printf "sed -i '1i#include <functional>\\n#include <unordered_map>\\n' include/cpp2util.h\n"
  fi
  sed -i '1i#include <functional>\n#include <unordered_map>\n' include/cpp2util.h

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building cppfront-compiler with make"
  fi

  if ! make; then
    echo "✗ cppfront make failed"
    navigate-to-repo-root || return 1
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] cppfront make completed successfully"
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: cd ../.."
  fi

  navigate-to-repo-root || return 1

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Validating cppfront-compiler binary"
  fi

  if [ ! -f "thirdparty/cppfront/cppfront-compiler" ] || [ ! -x "thirdparty/cppfront/cppfront-compiler" ]; then
    echo "✗ cppfront-compiler binary not found or not executable"
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] cppfront-compiler binary created and executable"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Testing cppfront-compiler..."
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: ./thirdparty/cppfront/cppfront-compiler -version"
  fi

  if ! ./thirdparty/cppfront/cppfront-compiler -version >/dev/null 2>&1; then
    echo "✗ cppfront-compiler test failed"
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] cppfront-compiler runs correctly (exit code: 0)"
  fi

  add-to-path "$PWD/thirdparty/cppfront"

  if [ "$debug_level" -ge 1 ]; then
    local end_time
    end_time=$(date +%s)
    local start_time
    start_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-cppfront completed in $duration seconds"
  fi

  echo "cppfront-compiler built and validated successfully"
}

build-xdp2-compiler() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] build-xdp2-compiler started at $(date)"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Starting build-xdp2-compiler function"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Cleaning xdp2-compiler build directory"
  fi

  clean-xdp2-compiler

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: cd src/tools/compiler"
  fi

  navigate-to-component "src/tools/compiler" || return 1

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi

  make clean || true

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building xdp2-compiler with make"
  fi

  if ! make; then
    echo "✗ xdp2-compiler make failed"
    navigate-to-repo-root || return 1
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] xdp2-compiler make completed successfully"
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: cd ../../.."
  fi

  navigate-to-repo-root || return 1

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Validating xdp2-compiler binary"
  fi

  if [ ! -f "src/tools/compiler/xdp2-compiler" ] || [ ! -x "src/tools/compiler/xdp2-compiler" ]; then
    echo "✗ xdp2-compiler binary not found or not executable"
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] xdp2-compiler binary created and executable"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Testing xdp2-compiler..."
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: ./src/tools/compiler/xdp2-compiler --help"
  fi

  if ! ./src/tools/compiler/xdp2-compiler --help >/dev/null 2>&1; then
    echo "✗ xdp2-compiler test failed"
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] xdp2-compiler runs correctly (exit code: 0)"
  fi

  if [ "$debug_level" -ge 1 ]; then
    local end_time
    end_time=$(date +%s)
    local start_time
    start_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-xdp2-compiler completed in $duration seconds"
  fi

  echo "xdp2-compiler built and validated successfully"
}

build-xdp2() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] build-xdp2 started at $(date)"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Starting build-xdp2 function"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Cleaning xdp2 build directory"
  fi

  clean-xdp2

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: cd src"
  fi

  navigate-to-component "src" || return 1

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: make clean"
  fi

  make clean || true

  add-to-path "$PWD/tools/compiler"
  echo "Added tools/compiler to PATH"

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building xdp2 project with make"
  fi

  if ! make; then
    echo "✗ xdp2 make failed"
    navigate-to-repo-root || return 1
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] xdp2 make completed successfully"
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] About to run: cd .."
  fi

  navigate-to-repo-root || return 1

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Validating xdp2 binaries"
  fi

  # Check required binaries
  if [ ! -f "src/xdp2" ]; then
    echo "✗ Required binary not found: src/xdp2"
    return 1
  fi
  if [ ! -f "src/libxdp2.a" ]; then
    echo "✗ Required binary not found: src/libxdp2.a"
    return 1
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] All xdp2 binaries created successfully"
  fi

  if [ "$debug_level" -ge 1 ]; then
    local end_time
    end_time=$(date +%s)
    local start_time
    start_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-xdp2 completed in $duration seconds"
  fi

  echo "xdp2 project built and validated successfully"
}

# Utility functions
check-cppfront-age() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] check-cppfront-age started at $(date)"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Starting check-cppfront-age function"
  fi

  local cppfront_binary="thirdparty/cppfront/cppfront-compiler"
  local max_age_days=7

  if [ ! -f "$cppfront_binary" ]; then
    if [ "$debug_level" -ge 2 ]; then
      echo "[DEBUG] cppfront-compiler not found, building..."
    fi
    build-cppfront
    return $?
  fi

  local file_age_days
  file_age_days=$(find "$cppfront_binary" -mtime +$max_age_days 2>/dev/null | wc -l)

  if [ "$file_age_days" -gt 0 ]; then
    if [ "$debug_level" -ge 2 ]; then
      echo "[DEBUG] cppfront-compiler is older than $max_age_days days, rebuilding..."
    fi
    build-cppfront
    return $?
  else
    if [ "$debug_level" -ge 2 ]; then
      echo "[DEBUG] cppfront-compiler is up to date (less than $max_age_days days old)"
    fi
    echo "cppfront-compiler is up to date"
  fi

  if [ "$debug_level" -ge 1 ]; then
    local end_time
    end_time=$(date +%s)
    local start_time
    start_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] check-cppfront-age completed in $duration seconds"
  fi
}

# Composite functions (call the individual functions above)
build-all() {
  if [ -n "$XDP2_NIX_DEBUG" ]; then
    local debug_level=$XDP2_NIX_DEBUG
  else
    local debug_level=0
  fi

  if [ "$debug_level" -ge 1 ]; then
    echo "[DEBUG] build-all started at $(date)"
  fi

  if [ "$debug_level" -ge 2 ]; then
    echo "[DEBUG] Starting build-all function"
  fi

  echo "Building all XDP2 components..."

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building cppfront compiler"
  fi

  if ! build-cppfront; then
    echo "✗ build-cppfront failed"
    return 1
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building xdp2-compiler"
  fi

  if ! build-xdp2-compiler; then
    echo "✗ build-xdp2-compiler failed"
    return 1
  fi

  if [ "$debug_level" -ge 3 ]; then
    echo "[DEBUG] Building xdp2 project"
  fi

  if ! build-xdp2; then
    echo "✗ build-xdp2 failed"
    return 1
  fi

  if [ "$debug_level" -ge 1 ]; then
    local end_time
    end_time=$(date +%s)
    local start_time
    start_time=$(date +%s)
    local duration=$((end_time - start_time))
    echo "[DEBUG] build-all completed in $duration seconds"
  fi

  echo "All XDP2 components built successfully!"
}

clean-all() {
  echo "Cleaning all build artifacts..."

  clean-cppfront
  clean-xdp2-compiler
  clean-xdp2

  echo "✓ All build artifacts cleaned"
}

# Validation and help functions
run-shellcheck() {
  echo "This is a placeholder for the run-shellcheck function"
}

xdp2-help() {
  echo "This is a placeholder for the xdp2-help function"
}
EOF

            # Use shellcheck on the temporary script
            if shellcheck -s bash "$temp_script"; then
              echo "✓ All functions passed shellcheck validation with proper context"
            else
              echo "✗ Some functions failed shellcheck validation"
              echo "Running detailed validation..."

              # Run shellcheck with detailed output
              shellcheck -s bash "$temp_script"
            fi

            # Clean up temporary script
            rm -f "$temp_script"

            echo ""
            echo "=== Shellcheck Validation Complete ==="
            echo "All functions have been checked for shellcheck compliance"

            # End timing for debug levels > 3
            if [ "$debug_level" -gt 3 ]; then
              end_time=$(date +%s)
              local duration=$((end_time - start_time))
              echo "[DEBUG] run-shellcheck completed in $duration seconds"
            fi

            echo "✓ Shellcheck validation completed"
            return 0
          }
        '';

        platform-compatibility-check-fn = ''
          check-platform-compatibility() {
            if [ "$(uname)" != "Linux" ]; then
              echo "⚠️  PLATFORM COMPATIBILITY NOTICE
==================================

🍎 You are running on $(uname) (not Linux)

The XDP2 development environment includes Linux-specific packages
like libbpf that are not available on $(uname) systems.

📋 Available platforms:
   ✅ Linux (x86_64-linux, aarch64-linux, etc.)
   ❌ macOS (x86_64-darwin, aarch64-darwin)
   ❌ Other Unix systems

Exiting development shell..."
              exit 1
            fi
          }
        '';

        detect-repository-root-fn = ''
          detect-repository-root() {
            XDP2_REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)
            export XDP2_REPO_ROOT

            if [ ! -d "$XDP2_REPO_ROOT" ]; then
              echo "⚠ WARNING: Could not detect valid repository root
📁 Repository root: $XDP2_REPO_ROOT"
              XDP2_REPO_ROOT="$PWD"
            else
              echo "📁 Repository root: $XDP2_REPO_ROOT"
            fi
          }
        '';

        setup-locale-support-fn = ''
          setup-locale-support() {
            # Only set locale if user hasn't already configured it
            if [ -z "$$LANG" ] || [ -z "$$LC_ALL" ]; then
              # Try to use system default, fallback to C.UTF-8
              export LANG=$${LANG:-C.UTF-8}
              export LC_ALL=$${LC_ALL:-C.UTF-8}
            fi

            # Verify locale is available (only if locale command exists)
            if command -v locale >/dev/null 2>&1; then
              if ! locale -a 2>/dev/null | grep -q "$$LANG"; then
                echo "⚠️  Locale $$LANG not available, using C.UTF-8"
                export LANG=C.UTF-8
                export LC_ALL=C.UTF-8
              fi
            fi
          }
        '';

        xdp2-help-fn = ''
          xdp2-help() {
            echo "🚀 === XDP2 Development Shell Help ===

📦 Compiler: GCC
🔧 GCC and Clang are available in the environment.
🐛 Debugging tools: gdb, valgrind, strace, ltrace

🔍 DEBUGGING:
  XDP2_NIX_DEBUG=0 - No extra debug. Default
  XDP2_NIX_DEBUG=3 - Basic debug
  XDP2_NIX_DEBUG=5 - Show compiler selection and config.mk
  XDP2_NIX_DEBUG=6 - Show all debug output including environment variables

⚙️  BUILD COMMANDS:
  build-cppfront       - Build cppfront compiler
  build-xdp2-compiler  - Build xdp2 compiler
  build-xdp2           - Build main XDP2 project
  build-all            - Build all components
  clean-all            - Clean all build artifacts
  clean-cppfront       - Clean cppfront build artifacts
  clean-xdp2-compiler  - Clean xdp2-compiler build artifacts
  clean-xdp2           - Clean xdp2 build artifacts
  check-cppfront-age   - Check and rebuild cppfront if needed
  run-shellcheck       - Validate all shell functions

💡 QUICK START:
  • Run 'build-all' to build everything
  • Run 'clean-all' to clean all artifacts
  • Run 'run-shellcheck' to validate shell functions

📁 PROJECT STRUCTURE:
  • src/              - Main XDP2 source code
  • thirdparty/cppfront/ - Cppfront compiler
  • samples/          - Example code and parsers
  • documentation/    - Project documentation

🎯 Ready to develop! 'xdp2-help' for help"
          }
        '';

        shell-aliases = ''
          alias xdp2-src='cd src'
          alias xdp2-samples='cd samples'
          alias xdp2-docs='cd documentation'
          alias xdp2-cppfront='cd thirdparty/cppfront'
        '';

        colored-prompt = ''
          export PS1="\[\033[0;32m\][XDP2-${sharedConfig.compilerInfo}] \[\033[01;34m\][\u@\h:\w]\$ \[\033[0m\]"
        '';

        ascii-art-logo = ''
          if command -v jp2a >/dev/null 2>&1 && [ -f "./documentation/images/xdp2-big.png" ]; then
            echo "$(jp2a --colors ./documentation/images/xdp2-big.png)"
            echo ""
          else
            echo "🚀 === XDP2 Development Shell ==="
          fi
        '';

        minimal-shell-entry = ''
          echo "🚀 === XDP2 Development Shell ==="
          echo "📦 Compiler: ${sharedConfig.compilerInfo}"
          echo "🔧 GCC and Clang are available in the environment"
          echo "🐛 Debugging tools: gdb, valgrind, strace, ltrace"
          echo "🎯 Ready to develop! 'xdp2-help' for help"
        '';

        debug-compiler-selection = ''
            if [ ${toString sharedConfig.nixDebug} -gt 4 ]; then
            echo "=== COMPILER SELECTION ==="
              echo "Using compiler: ${sharedConfig.compilerInfo}"
            echo "HOST_CC: $HOST_CC"
            echo "HOST_CXX: $HOST_CXX"
            $HOST_CC --version
            $HOST_CXX --version
            echo "=== End compiler selection ==="
            fi
        '';

        debug-environment-vars = ''
            if [ ${toString sharedConfig.nixDebug} -gt 5 ]; then
              echo "=== Environment Variables ==="
              env
              echo "=== End Environment Variables ==="
            fi
        '';


        navigate-to-repo-root-fn = ''
          navigate-to-repo-root() {
            if [ -n "$XDP2_REPO_ROOT" ]; then
              cd "$XDP2_REPO_ROOT" || return 1
            else
              echo "✗ ERROR: XDP2_REPO_ROOT not set"
              return 1
            fi
          }
        '';

        navigate-to-component-fn = ''
          navigate-to-component() {
            local component="$1"
            local target_dir="$XDP2_REPO_ROOT/$component"

            if [ ! -d "$target_dir" ]; then
              echo "✗ ERROR: Component directory not found: $target_dir"
              return 1
            fi

            cd "$target_dir" || return 1
          }
        '';

        add-to-path-fn = ''
          # Add path to PATH environment variable if not already present
          add-to-path() {
            local path_to_add="$1"

            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi

            # Check if path is already in PATH
            if [[ ":$PATH:" == *":$path_to_add:"* ]]; then
              if [ "$debug_level" -gt 3 ]; then
                echo "[DEBUG] Path already in PATH: $path_to_add"
              fi
              return 0
            fi

            # Add path to beginning of PATH
            if [ "$debug_level" -gt 3 ]; then
              echo "[DEBUG] Adding to PATH: $path_to_add"
              echo "[DEBUG] PATH before: $PATH"
            fi

            export PATH="$path_to_add:$PATH"

            if [ "$debug_level" -gt 3 ]; then
              echo "[DEBUG] PATH after: $PATH"
            fi
          }
        '';

        # Individual clean functions (centralized cleaning logic)
        clean-cppfront-fn = ''
          # Clean cppfront build artifacts
          clean-cppfront() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi

            # Navigate to repository root first
            navigate-to-repo-root || return 1

            # Navigate to cppfront directory
            navigate-to-component "thirdparty/cppfront" || return 1

            # Debug output for clean command
            if [ "$debug_level" -gt 3 ]; then
              echo "[DEBUG] About to run: rm -f cppfront-compiler"
            fi
            rm -f cppfront-compiler  # Remove the binary directly since Makefile has no clean target

            # Return to repository root
            navigate-to-repo-root || return 1
          }
        '';

        clean-xdp2-compiler-fn = ''
          # Clean xdp2-compiler build artifacts
          clean-xdp2-compiler() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi

            # Navigate to repository root first
            navigate-to-repo-root || return 1

            # Navigate to xdp2-compiler directory
            navigate-to-component "src/tools/compiler" || return 1

            # Debug output for clean command
            if [ "$debug_level" -gt 3 ]; then
              echo "[DEBUG] About to run: make clean"
            fi
            make clean || true  # Don't fail if clean fails

            # Return to repository root
            navigate-to-repo-root || return 1
          }
        '';

        clean-xdp2-fn = ''
          # Clean xdp2 build artifacts
          clean-xdp2() {
            if [ -n "$XDP2_NIX_DEBUG" ]; then
              local debug_level=$XDP2_NIX_DEBUG
            else
              local debug_level=0
            fi

            # Navigate to repository root first
            navigate-to-repo-root || return 1

            # Navigate to src directory
            navigate-to-component "src" || return 1

            # Debug output for clean command
            if [ "$debug_level" -gt 3 ]; then
              echo "[DEBUG] About to run: make clean"
            fi
            make clean || true  # Don't fail if clean fails

            # Return to repository root
            navigate-to-repo-root || return 1
          }
        '';

        # Combined build functions (ordered to avoid SC2218 - functions called before definition)
        build-functions = ''
          # Navigation functions (called by all other functions)
          ${navigate-to-repo-root-fn}
          ${navigate-to-component-fn}

          # Utility functions
          ${add-to-path-fn}

          # Individual clean functions (called by build functions and clean-build)
          ${clean-cppfront-fn}
          ${clean-xdp2-compiler-fn}
          ${clean-xdp2-fn}
          # Individual build functions (called by build-all)
          ${build-cppfront-fn}
          ${build-xdp2-compiler-fn}
          ${build-xdp2-fn}

          # Utility functions
          ${check-cppfront-age-fn}

          # Composite functions (call the individual functions above)
          ${build-all-fn}
          ${clean-all-fn}

          # Validation and help functions
          ${platform-compatibility-check-fn}
          ${detect-repository-root-fn}
          ${setup-locale-support-fn}
          ${run-shellcheck-fn}
          ${xdp2-help-fn}
        '';

      in
      {
        devShells.default = pkgs.mkShell {
          packages = sharedConfig.corePackages;

          shellHook = ''
            ${sharedEnvVars}

            ${build-functions}

            check-platform-compatibility
            detect-repository-root
            setup-locale-support

            ${debug-compiler-selection}
            ${debug-environment-vars}

            ${ascii-art-logo}

            ${smart-configure}
            smart-configure

            ${shell-aliases}

            ${colored-prompt}

            ${minimal-shell-entry}
          '';
        };
      });
}