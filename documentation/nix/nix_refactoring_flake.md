# Refactoring flake.nix

This document will discuss how to refactor the flake.nix, based on improvements to the nix.md and while keeping in mind the learnings from nix_flake_debug_and_progess_log.md.

# Current Situation

The `nix develop` command currently fails during the build of the `xdp2-build` derivation. The detailed logs in `nix_flake_debug_and_progress_log.md` show that the failure occurs when building the `cppfront-compiler`, a third-party dependency.

### Root Cause Analysis

1.  **Compiler Requirement**: The `cppfront-compiler` and the main `xdp2-compiler` both require `clang++` for compilation. As detailed in `nix.md`, the build system uses the `HOST_CXX` variable specifically for these host-side tools.

2.  **Incorrect Compiler Usage**: The build log shows that `g++` is being used to compile `cppfront-compiler`, which leads to compilation errors because the code is not compatible with `g++`.
    ```
    g++ -std=c++20 source/cppfront.cpp -o cppfront-compiler
    ...
    source/../include/cpp2util.h:10051:33: error: 'function' in namespace 'std' does not name a template type
    ```

3.  **Makefile Precedence**: The root cause is that the project's `configure` script generates a `config.mk` file that hardcodes the compiler:
    ```makefile
    HOST_CXX := g++
    ```
    This `Makefile` variable assignment (`:=`) takes precedence over any environment variables (like `export HOST_CXX=clang++`) or command-line arguments (`make CXX=clang++`) we provide in the Nix derivation. This forces the build to use `g++` for host tools, directly causing the failure.

# Refactoring Plan

To fix the build, we must ensure that the `config.mk` file generated by the `configure` script contains the correct compiler setting for host tools. The most robust and direct way to achieve this is to patch the `configure` script itself within the Nix derivation.

This approach is superior to passing variables to `make` because it fixes the problem at its source, ensuring the entire build process respects the dual-compiler architecture (`clang++` for host tools, `gcc` for target libraries) outlined in `nix.md`.

### Proposed `flake.nix` Changes

We will modify the `xdp2-build` derivation in `flake.nix` to include a `patchPhase` that corrects the `configure` script before it runs.

1.  **Add a `patchPhase`**: Use `substituteInPlace` to modify the `src/configure` script. This will change the line that hardcodes `g++` to use `clang++` instead.

2.  **Simplify `preBuild`**: The `preBuild` phase was a temporary workaround to debug the `cppfront-compiler` build. Since our `patchPhase` fixes the root cause, the `make` command for `cppfront` will now correctly use `clang++` via the `HOST_CXX` variable from the generated `config.mk`. We can simplify or remove the explicit `CXX` override in the `preBuild` `make` command.

### Example Implementation

Here is how the relevant part of the `xdp2-build` derivation in `flake.nix` would look:

```nix
xdp2-build = pkgs.stdenv.mkDerivation {
  pname = "xdp2-build";
  version = "dev";
  src = ./.;

  # ... other inputs ...

  patchPhase = ''
    # Go to the directory containing the configure script
    cd src
    # Fix the configure script to use clang++ for HOST_CXX
    substituteInPlace configure \
      --replace 'echo "HOST_CXX := g++"' 'echo "HOST_CXX := clang++"'
  '';

  # ... configurePhase, buildPhase, etc. ...
};
```

By implementing this change, the `configure` script will generate the correct `config.mk`, the `cppfront-compiler` will be built with `clang++` as required, and the overall derivation build should succeed. This aligns the Nix environment with the project's documented compiler architecture.

# Observations post implementation

The `patchPhase` change was successful in forcing the build system to use `clang++`. However, the build still fails, but now with a different set of errors originating from `clang++`.

```
[das@l:~/Downloads/xdp2]$ nix develop
warning: Git tree '/home/das/Downloads/xdp2' is dirty
error: builder for '/nix/store/fh9p5zjsg0phvj2x6xfmk60laazrv83v-xdp2-build-dev.drv' failed with exit code 2;
       last 25 log lines:
       >       |                ~~^~~~~~~~~~~~~~~~~~~~
       > source/parse.h:7017:18: note: place parentheses around the assignment to silence this warning
       >  7017 |         while (e = match_expression()) {
       >       |                  ^
       >       |                (                     )
       > source/parse.h:7017:18: note: use '==' to turn this assignment into an equality comparison
       >  7017 |         while (e = match_expression()) {
       >       |                  ^
       >       |                  ==
       > In file included from source/cppfront.cpp:18:
       > In file included from source/to_cpp1.h:21:
       > source/match.h:1709:19: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
       >  1709 |     while (ip_opt = loop_cond()) {
       >       |            ~~~~~~~^~~~~~~~~~~~~
       > source/match.h:1709:19: note: place parentheses around the assignment to silence this warning
       >  1709 |     while (ip_opt = loop_cond()) {
       >       |                   ^
       >       |            (                   )
       > source/match.h:1709:19: note: use '==' to turn this assignment into an equality comparison
       >  1709 |     while (ip_opt = loop_cond()) {
       >       |                   ^
       >       |                   ==
       > 3 warnings and 10 errors generated.
       > make: *** [Makefile:12: compiler] Error 1
       > make: Leaving directory '/build/ymdw10r7m0b341f6s7mqja8a8sissc85-source/thirdparty/cppfront'
       For full logs, run:
         nix log /nix/store/fh9p5zjsg0phvj2x6xfmk60laazrv83v-xdp2-build-dev.drv
error: 1 dependencies of derivation '/nix/store/mindjn251y3h9sz1ka8xfrqkgqr0kv7i-nix-shell-env.drv' failed to build

[das@l:~/Downloads/xdp2]$ nix log /nix/store/fh9p5zjsg0phvj2x6xfmk60laazrv83v-xdp2-build-dev.drv
Running phase: unpackPhase
@nix { "action": "setPhase", "phase": "unpackPhase" }
unpacking source archive /nix/store/l0qwr5hbmidxcrkjlj9lv4yj43hi13lm-ymdw10r7m0b341f6s7mqja8a8sissc85-source
source root is ymdw10r7m0b341f6s7mqja8a8sissc85-source
Running phase: patchPhase
@nix { "action": "setPhase", "phase": "patchPhase" }
Running phase: updateAutotoolsGnuConfigScriptsPhase
@nix { "action": "setPhase", "phase": "updateAutotoolsGnuConfigScriptsPhase" }
Running phase: configurePhase
@nix { "action": "setPhase", "phase": "configurePhase" }


Platform is default
Architecture is x86_64
Architecture includes for x86_64 not found, using generic
Target Architecture is
COMPILER is gcc
XDP2_CLANG_VERSION=20.1.8
XDP2_C_INCLUDE_PATH=/nix/store/d3bv4bj7klgfc1w1x01d91a1f4g7ywga-llvm-20.1.8-lib/lib/clang/20/include
XDP2_CLANG_RESOURCE_PATH=/nix/store/d3bv4bj7klgfc1w1x01d91a1f4g7ywga-llvm-20.1.8-lib/lib/clang/20

Running phase: buildPhase
@nix { "action": "setPhase", "phase": "buildPhase" }
--- Building cppfront-compiler dependency ---
make: Entering directory '/build/ymdw10r7m0b341f6s7mqja8a8sissc85-source/thirdparty/cppfront'
clang++ -std=c++20 source/cppfront.cpp -o cppfront-compiler
In file included from source/cppfront.cpp:18:
In file included from source/to_cpp1.h:21:
In file included from source/match.h:4:
In file included from source/cpp2util.h:1:
source/../include/cpp2util.h:10051:33: error: no template named 'function' in namespace 'std'
 10051 |         using attrs_type = std::function<bool(graph_attrs const&)>;
       |                            ~~~~~^
source/../include/cpp2util.h:10055:9: error: unknown type name 'attrs_type'
 10055 |         attrs_type attrs;
       |         ^
source/../include/cpp2util.h:10300:14: error: no member named 'unordered_map' in namespace 'std'
 10300 |         std::unordered_map<Type, Type>
       |         ~~~~~^
source/../include/cpp2util.h:10300:28: error: 'Type' does not refer to a value
 10300 |         std::unordered_map<Type, Type>
       |                            ^
source/../include/cpp2util.h:10289:20: note: declared here
 10289 | template <typename Type, bool ValueIsIndex = false>
       |                    ^
source/../include/cpp2util.h:10300:39: error: expected ';' after alias declaration
 10300 |         std::unordered_map<Type, Type>
       |                                       ^
       |                                       ;
source/../include/cpp2util.h:10305:14: error: no member named 'unordered_map' in namespace 'std'
 10305 |         std::unordered_map<Type, size_t>
       |         ~~~~~^
source/../include/cpp2util.h:10305:28: error: 'Type' does not refer to a value
 10305 |         std::unordered_map<Type, size_t>
       |                            ^
source/../include/cpp2util.h:10289:20: note: declared here
 10289 | template <typename Type, bool ValueIsIndex = false>
       |                    ^
source/../include/cpp2util.h:10305:41: error: expected ';' after alias declaration
 10305 |         std::unordered_map<Type, size_t>
       |                                         ^
       |                                         ;
source/../include/cpp2util.h:10308:5: error: unknown type name 'parent_container_type'
 10308 |     parent_container_type parent;
       |     ^
source/../include/cpp2util.h:10309:5: error: unknown type name 'size_container_type'
 10309 |     size_container_type size;
       |     ^
In file included from source/cppfront.cpp:18:
In file included from source/to_cpp1.h:21:
In file included from source/match.h:6:
source/parse.h:6995:18: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
 6995 |         while (a = match_arrow()) {
      |                ~~^~~~~~~~~~~~~~~
source/parse.h:6995:18: note: place parentheses around the assignment to silence this warning
 6995 |         while (a = match_arrow()) {
      |                  ^
      |                (                )
source/parse.h:6995:18: note: use '==' to turn this assignment into an equality comparison
 6995 |         while (a = match_arrow()) {
      |                  ^
      |                  ==
source/parse.h:7017:18: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
 7017 |         while (e = match_expression()) {
      |                ~~^~~~~~~~~~~~~~~~~~~~
source/parse.h:7017:18: note: place parentheses around the assignment to silence this warning
 7017 |         while (e = match_expression()) {
      |                  ^
      |                (                     )
source/parse.h:7017:18: note: use '==' to turn this assignment into an equality comparison
 7017 |         while (e = match_expression()) {
      |                  ^
      |                  ==
In file included from source/cppfront.cpp:18:
In file included from source/to_cpp1.h:21:
source/match.h:1709:19: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
 1709 |     while (ip_opt = loop_cond()) {
      |            ~~~~~~~^~~~~~~~~~~~~
source/match.h:1709:19: note: place parentheses around the assignment to silence this warning
 1709 |     while (ip_opt = loop_cond()) {
      |                   ^
      |            (                   )
source/match.h:1709:19: note: use '==' to turn this assignment into an equality comparison
 1709 |     while (ip_opt = loop_cond()) {
      |                   ^
      |                   ==
3 warnings and 10 errors generated.
make: *** [Makefile:12: compiler] Error 1
make: Leaving directory '/build/ymdw10r7m0b341f6s7mqja8a8sissc85-source/thirdparty/cppfront'

[das@l:~/Downloads/xdp2]$
```

-
-Next steps
+### Observations
+
+1.  **Success! We are using `clang++`**: The log clearly shows the command `clang++ -std=c++20 source/cppfront.cpp -o cppfront-compiler`. This confirms our `patchPhase` worked perfectly and we have resolved the compiler mismatch issue.
+
+2.  **New Failure Mode**: The build now fails during compilation with `clang++`. The errors are:
+    ```
+    source/../include/cpp2util.h:10051:33: error: no template named 'function' in namespace 'std'
+    source/../include/cpp2util.h:10300:14: error: no member named 'unordered_map' in namespace 'std'
+    ```
+
+3.  **Root Cause**: These errors indicate that the source code (`cpp2util.h`) is using C++ standard library features (`std::function`, `std::unordered_map`) without including the necessary headers (`<functional>`, `<unordered_map>`). While some compilers or environments might implicitly include these, the strict Nix build environment does not. The code is not self-contained.
+
+### Next Steps
+
+The most direct and robust solution is to fix the `cppfront` source code by adding the missing includes. This makes the third-party code more portable and fixes the build at its source. We will add another `patchPhase` command to insert the required `#include` directives.
+
+1.  **Update `patchPhase` in `flake.nix`**: Use `substituteInPlace` to add `#include <functional>` and `#include <unordered_map>` to the top of `thirdparty/cppfront/include/cpp2util.h`.
+
+This should resolve the final compilation errors and allow the `xdp2-build` derivation to complete successfully.



## New Logs

Log of the most recent "nix develop" build:
```
[das@l:~/Downloads/xdp2]$ nix develop
warning: Git tree '/home/das/Downloads/xdp2' is dirty
error: builder for '/nix/store/59l38gbwbrdlmd8w2ifrf8lsr4r9z74q-xdp2-build-dev.drv' failed with exit code 2;
       last 25 log lines:
       > make: Leaving directory '/build/1qma60pi8kzkf8r0j7h4hd3lpmx2aayh-source/thirdparty/cppfront'
       > build flags: SHELL=/nix/store/q7sqwn7i6w2b67adw0bmix29pxg85x3w-bash-5.3p3/bin/bash
       >
       > tools
       >     CC       get_uet_udp_port
       > WARNING: Could not retrieve the OS's nameserver !
       > WARNING: Could not retrieve the OS's nameserver !
       >     CC       get_falcon_udp_port
       > WARNING: Could not retrieve the OS's nameserver !
       >     CC       get_sue_udp_port
       > WARNING: Could not retrieve the OS's nameserver !
       > include/xdp2gen/llvm/patterns.h2... ok (mixed Cpp1/Cpp2, Cpp2 code passes safety checks)
       >
       > include/xdp2gen/ast-consumer/patterns.h2... ok (mixed Cpp1/Cpp2, Cpp2 code passes safety checks)
       >
       >     CXX      src/main.o
       > Unknown option --with-path=/nix/store/rz4bmcm8dwsy7ylx6rhffkwkqn6n8srn-ncurses-6.5-dev/lib/pkgconfig:/nix/store/29mcvdnd9s6sp46cjmqm0pfg4xs56rik-zlib-1.3.1-dev/lib/pkgconfig:/nix/store/20cck0r5dvh21c4w7wy8j3f7cc6wb5k2-boost-1.87.0-dev/lib/pkgconfig:/nix/store/0crnzrvmjwvsn2z13v82w71k9nvwafbd-libpcap-1.10.5/lib/pkgconfig:/nix/store/nsr3sad722q5b6r2xgc0iiwiqca3ili6-libelf-0.8.13/lib/pkgconfig:/nix/store/8jgnmlzb820a1bkff5bkwl1qi681qz7n-libbpf-1.6.2/lib/pkgconfig:/nix/store/j0438064c6zc94gr6xk6mkfvpaxxk8kd-python3-3.13.7-env/lib/pkgconfig
       > In file included from src/main.cpp:50:
       > include/xdp2gen/python_generators.h:36:10: fatal error: 'Python.h' file not found
       >    36 | #include <Python.h>
       >       |          ^~~~~~~~~~
       > 1 error generated.
       > make[2]: *** [../../config.mk:76: src/main.o] Error 1
       > make[1]: *** [Makefile:14: compiler] Error 2
       > make: *** [Makefile:74: all] Error 2
       For full logs, run:
         nix log /nix/store/59l38gbwbrdlmd8w2ifrf8lsr4r9z74q-xdp2-build-dev.drv
error: 1 dependencies of derivation '/nix/store/b4cy3ihdsji0kkvsfyb2586sw7anczl8-nix-shell-env.drv' failed to build

[das@l:~/Downloads/xdp2]$ nix log /nix/store/59l38gbwbrdlmd8w2ifrf8lsr4r9z74q-xdp2-build-dev.drv
Running phase: unpackPhase
@nix { "action": "setPhase", "phase": "unpackPhase" }
unpacking source archive /nix/store/0ghid6s2mnczvy4bm81r18m4128b15w9-1qma60pi8kzkf8r0j7h4hd3lpmx2aayh-source
source root is 1qma60pi8kzkf8r0j7h4hd3lpmx2aayh-source
Running phase: patchPhase
@nix { "action": "setPhase", "phase": "patchPhase" }
Running phase: updateAutotoolsGnuConfigScriptsPhase
@nix { "action": "setPhase", "phase": "updateAutotoolsGnuConfigScriptsPhase" }
Running phase: configurePhase
@nix { "action": "setPhase", "phase": "configurePhase" }


Platform is default
Architecture is x86_64
Architecture includes for x86_64 not found, using generic
Target Architecture is
COMPILER is gcc
XDP2_CLANG_VERSION=20.1.8
XDP2_C_INCLUDE_PATH=/nix/store/d3bv4bj7klgfc1w1x01d91a1f4g7ywga-llvm-20.1.8-lib/lib/clang/20/include
XDP2_CLANG_RESOURCE_PATH=/nix/store/d3bv4bj7klgfc1w1x01d91a1f4g7ywga-llvm-20.1.8-lib/lib/clang/20

Running phase: buildPhase
@nix { "action": "setPhase", "phase": "buildPhase" }
--- Building cppfront-compiler dependency ---
make: Entering directory '/build/1qma60pi8kzkf8r0j7h4hd3lpmx2aayh-source/thirdparty/cppfront'
clang++ -std=c++20 source/cppfront.cpp -o cppfront-compiler
In file included from source/cppfront.cpp:18:
In file included from source/to_cpp1.h:21:
In file included from source/match.h:6:
source/parse.h:6995:18: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
 6995 |         while (a = match_arrow()) {
      |                ~~^~~~~~~~~~~~~~~
source/parse.h:6995:18: note: place parentheses around the assignment to silence this warning
 6995 |         while (a = match_arrow()) {
      |                  ^
      |                (                )
source/parse.h:6995:18: note: use '==' to turn this assignment into an equality comparison
 6995 |         while (a = match_arrow()) {
      |                  ^
      |                  ==
source/parse.h:7017:18: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
 7017 |         while (e = match_expression()) {
      |                ~~^~~~~~~~~~~~~~~~~~~~
source/parse.h:7017:18: note: place parentheses around the assignment to silence this warning
 7017 |         while (e = match_expression()) {
      |                  ^
      |                (                     )
source/parse.h:7017:18: note: use '==' to turn this assignment into an equality comparison
 7017 |         while (e = match_expression()) {
      |                  ^
      |                  ==
In file included from source/cppfront.cpp:18:
In file included from source/to_cpp1.h:21:
source/match.h:1709:19: warning: using the result of an assignment as a condition without parentheses [-Wparentheses]
 1709 |     while (ip_opt = loop_cond()) {
      |            ~~~~~~~^~~~~~~~~~~~~
source/match.h:1709:19: note: place parentheses around the assignment to silence this warning
 1709 |     while (ip_opt = loop_cond()) {
      |                   ^
      |            (                   )
source/match.h:1709:19: note: use '==' to turn this assignment into an equality comparison
 1709 |     while (ip_opt = loop_cond()) {
      |                   ^
      |                   ==
3 warnings generated.
make: Leaving directory '/build/1qma60pi8kzkf8r0j7h4hd3lpmx2aayh-source/thirdparty/cppfront'
build flags: SHELL=/nix/store/q7sqwn7i6w2b67adw0bmix29pxg85x3w-bash-5.3p3/bin/bash

tools
    CC       get_uet_udp_port
WARNING: Could not retrieve the OS's nameserver !
WARNING: Could not retrieve the OS's nameserver !
    CC       get_falcon_udp_port
WARNING: Could not retrieve the OS's nameserver !
    CC       get_sue_udp_port
WARNING: Could not retrieve the OS's nameserver !
include/xdp2gen/llvm/patterns.h2... ok (mixed Cpp1/Cpp2, Cpp2 code passes safety checks)

include/xdp2gen/ast-consumer/patterns.h2... ok (mixed Cpp1/Cpp2, Cpp2 code passes safety checks)

    CXX      src/main.o
Unknown option --with-path=/nix/store/rz4bmcm8dwsy7ylx6rhffkwkqn6n8srn-ncurses-6.5-dev/lib/pkgconfig:/nix/store/29mcvdnd9s6sp46cjmqm0pfg4xs56rik-zlib-1.3.1-dev/lib/pkgconfig:/nix/store/20cck0r5dvh21c4w7wy8j3f7cc6wb5k2-boost-1.87.0-dev/lib/pkgconfig:/nix/>
In file included from src/main.cpp:50:
include/xdp2gen/python_generators.h:36:10: fatal error: 'Python.h' file not found
   36 | #include <Python.h>
      |          ^~~~~~~~~~
1 error generated.
make[2]: *** [../../config.mk:76: src/main.o] Error 1
make[1]: *** [Makefile:14: compiler] Error 2
make: *** [Makefile:74: all] Error 2

[das@l:~/Downloads/xdp2]$
```

## New Obvserations

New Observations + +1. cppfront-compiler Build Success!: The preBuild phase now completes successfully. The log shows clang++ being used, and the make command for thirdparty/cppfront exits without error. Our previous patches to configure and cpp2util.h were effective. + +2. Build Progresses to Main make: The build now proceeds past the preBuild step and into the main buildPhase, where it starts compiling the xdp2-compiler tool. + +3. New Failure: Python.h Not Found: The build now fails when compiling src/main.o for the xdp2-compiler. The error is:

## Hypothesis
The root cause of the 'Python.h' file not found error is the failure of the pkg-config command. + +The configure script generates a config.mk that constructs the Python-related compiler flags like this: +makefile +CFLAGS_PYTHON=`$(PKG_CONFIG) $(PATH_ARG) --cflags python$(PYTHON_VER)-embed` + Where PATH_ARG is defined as "--with-path=$PKG_CONFIG_PATH". + +Because the pkg-config command fails due to the unsupported --with-path option, the CFLAGS_PYTHON variable in the Makefile is not populated with the necessary -I flag pointing to the Python include directory. Consequently, the compiler cannot find Python.h.

## Next steps
The most direct solution is to patch the configure script to stop it from generating the invalid --with-path argument for pkg-config. pkg-config will automatically use the PKG_CONFIG_PATH environment variable, which is already correctly set in our Nix derivation. + +1. Update patchPhase in flake.nix: Use substituteInPlace to modify the src/configure script. We will change the line that generates PATH_ARG. +

Change echo "PATH_ARG=\"--with-path=$PKG_CONFIG_PATH\"" >> $CONFIG to echo "PATH_ARG=" >> $CONFIG to neutralize the variable.
+By making this change, the pkg-config command inside the generated config.mk will be valid, it will correctly use the PKG_CONFIG_PATH environment variable, CFLAGS_PYTHON will be set correctly, and the compiler will be able to find Python.h. + +This should be the final patch needed to get the xdp2-build derivation to complete successfully.

# Next steps

